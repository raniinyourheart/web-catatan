<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>web catatan + gambar</title>
  <style>
    :root{
      --bg:#0f172a;
      --panel:#111827;
      --muted:#94a3b8;
      --text:#e5e7eb;
      --accent:#22c55e;
      --accent-2:#3b82f6;
      --danger:#ef4444;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --radius:18px;
      --max-thumb:110px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:ui-sans-serif,system-ui,-apple-system,"segoe ui",roboto,ubuntu;
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(59,130,246,.22), transparent 60%),
        radial-gradient(1000px 600px at 120% 10%, rgba(34,197,94,.18), transparent 60%),
        var(--bg);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:20;
      background:rgba(15,23,42,.6); backdrop-filter:blur(6px);
      border-bottom:1px solid rgba(255,255,255,.04);
      padding:16px;
    }
    .wrap{max-width:1100px; margin:0 auto; display:flex; gap:12px; align-items:center}
    .logo{
      width:40px;height:40px;border-radius:10px;
      background:linear-gradient(135deg,var(--accent),var(--accent-2));
      display:grid; place-items:center; font-weight:800; color:#fff;
      box-shadow:var(--shadow)
    }
    .brand-title{font-size:18px;font-weight:700;text-transform:lowercase}
    .toolbar{margin-left:auto; display:flex; gap:10px; align-items:center}
    .search{
      min-width:320px; max-width:640px; display:flex; align-items:center; gap:10px;
      padding:10px 12px; border-radius:12px; background:rgba(17,24,39,.85);
      border:1px solid rgba(255,255,255,.04);
    }
    .search input{flex:1;background:transparent;border:0;outline:0;color:var(--text);font-size:14px}
    .btn{background:rgba(17,24,39,.9); border:1px solid rgba(255,255,255,.06); color:var(--text); padding:8px 12px;border-radius:10px; cursor:pointer; font-weight:600; text-transform:lowercase}
    .btn:hover{filter:brightness(1.05)}
    main{padding:20px}
    .grid{max-width:1100px;margin:0 auto; display:grid; gap:16px; grid-template-columns:repeat(auto-fill,minmax(240px,1fr))}
    .empty{text-align:center;color:var(--muted); margin-top:40px}
    .card{
      background:linear-gradient(180deg, rgba(17,24,39,.95), rgba(17,24,39,.9));
      border-radius:var(--radius); padding:14px; position:relative; box-shadow:var(--shadow);
      border:1px solid rgba(255,255,255,.04); min-height:150px; display:flex; flex-direction:column; gap:8px; overflow:hidden;
    }
    .card h3{margin:0;font-size:15px;letter-spacing:.2px}
    .card p{margin:0;color:var(--muted);font-size:13px;line-height:1.45;white-space:pre-wrap; flex:1}
    .thumbs{display:flex; gap:6px; flex-wrap:wrap}
    .thumb{width:calc((100% - 12px)/3); max-width:120px; aspect-ratio:4/3; overflow:hidden; border-radius:10px; border:1px solid rgba(255,255,255,.06); background:rgba(255,255,255,.02)}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .menu{position:absolute; top:10px; right:10px; display:flex; gap:8px}
    .icon-btn{width:36px;height:36px;border-radius:10px;display:grid;place-items:center;background:rgba(17,24,39,.85);border:1px solid rgba(255,255,255,.06);cursor:pointer}
    .meta{display:flex;align-items:center;justify-content:space-between; gap:8px; color:var(--muted); font-size:12px}
    .pill{font-size:11px;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.05);cursor:pointer}
    .fab{position:fixed; right:20px; bottom:20px; width:56px;height:56px;border-radius:14px;border:none; background:linear-gradient(135deg,var(--accent),var(--accent-2)); color:#fff; font-size:26px; cursor:pointer; box-shadow:var(--shadow)}
    .overlay{position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.5); padding:18px; z-index:60}
    .modal{width:100%; max-width:760px; background:var(--panel); border-radius:16px; padding:18px; display:flex; flex-direction:column; gap:12px; border:1px solid rgba(255,255,255,.04)}
    input[type="file"]{color:var(--muted)}
    input,textarea{width:100%; padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.06); background:rgba(2,6,23,.5); color:var(--text)}
    textarea{min-height:120px; resize:vertical}
    .row{display:flex; gap:10px; justify-content:flex-end; align-items:center}
    .primary{background:linear-gradient(135deg,var(--accent),var(--accent-2)); color:white; border:none}
    .preview{display:flex; gap:10px; flex-wrap:wrap}
    .pthumb{position:relative; width:var(--max-thumb); height:var(--max-thumb); border-radius:10px; overflow:hidden; border:1px solid rgba(255,255,255,.06)}
    .pthumb img{width:100%; height:100%; object-fit:cover}
    .pthumb button{position:absolute; top:6px; right:6px; background:rgba(17,24,39,.85); border:none;color:var(--text); padding:4px 6px; border-radius:8px; cursor:pointer}
    .hint{font-size:13px;color:var(--muted)}
    @media (max-width:520px){
      .search{min-width:120px}
      .wrap{flex-wrap:wrap}
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="logo">‚ú¶</div>
      <div class="brand-title">web catatan kamu</div>

      <div class="toolbar" style="margin-left:auto">
        <div class="search" title="cari catatan (judul atau isi)">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="opacity:.7"><path d="M21 21l-4.2-4.2" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/><circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="1.4"/></svg>
          <input id="search" placeholder="cari catatan‚Ä¶ (judul, isi)" />
        </div>
        <button class="btn" id="exportBtn">ekspor</button>
        <button class="btn" id="importBtn">impor</button>
        <input type="file" id="fileInput" accept="application/json" style="display:none" />
      </div>
    </div>
  </header>

  <main>
    <div class="grid" id="grid"></div>
    <div class="empty" id="empty" style="display:none">belum ada catatan. klik tombol plus di kanan bawah untuk membuat catatan pertama kamu ‚ú®</div>
  </main>

  <button class="fab" id="addBtn" title="tambah catatan">+</button>

  <!-- modal tambah / edit -->
  <div class="overlay" id="overlay" role="dialog" aria-modal="true">
    <div class="modal" role="document">
      <h3 id="modalTitle" style="text-transform:lowercase; margin:0">catatan baru</h3>

      <div class="field">
        <input id="noteTitle" placeholder="judul (opsional)" maxlength="140" />
      </div>

      <div class="field">
        <textarea id="noteBody" placeholder="tulis isi catatan di sini‚Ä¶"></textarea>
      </div>

      <div class="field">
        <input type="file" id="noteImages" accept="image/*" multiple />
        <div class="hint">pilih beberapa gambar (opsional). gambar akan dikompresi otomatis untuk menghemat penyimpanan.</div>
        <div class="preview" id="preview"></div>
      </div>

      <div class="row">
        <span class="hint" id="imgCount"></span>
        <div style="margin-left:auto; display:flex; gap:8px">
          <button class="btn" id="cancelBtn">batal</button>
          <button class="btn primary" id="saveBtn">simpan</button>
        </div>
      </div>
    </div>
  </div>

  <!-- modal lihat (readonly) -->
  <div class="overlay" id="viewOverlay" role="dialog" aria-modal="true">
    <div class="modal" role="document">
      <h3 id="viewTitle" style="margin:0; text-transform:lowercase">judul</h3>
      <div id="viewImages" class="preview"></div>
      <p id="viewBody" style="white-space:pre-wrap; margin:0"></p>
      <div class="hint" id="viewDates"></div>
      <div class="row"><button class="btn" id="closeViewBtn">tutup</button></div>
    </div>
  </div>

  <script>
    // helper
    const $ = s => document.querySelector(s);
    const fmt = ts => new Date(ts).toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' });

    // migration and state
    function migrate(){
      const v3 = localStorage.getItem('notes-v3');
      if (v3) return JSON.parse(v3);
      const v2 = localStorage.getItem('notes-v2');
      const v1 = localStorage.getItem('notes-v1');
      let res = [];
      if (v2){
        try { res = JSON.parse(v2).map(n => ({ ...n, images: Array.isArray(n.images) ? n.images : [] })); } catch {}
      } else if (v1){
        try { res = JSON.parse(v1).map(n => ({ id: n.id || crypto.randomUUID(), title: n.title || '', body: n.body || '', images: [], createdAt: n.createdAt || Date.now(), updatedAt: n.updatedAt || Date.now() })); } catch {}
      }
      localStorage.setItem('notes-v3', JSON.stringify(res));
      return res;
    }

    let notes = migrate();
    let editingId = null;
    let tempImages = [];

    // image compress params
    const MAX_W = 1600, MAX_H = 1600, JPG_QUALITY = 0.82;

    function persist(){ localStorage.setItem('notes-v3', JSON.stringify(notes)); }


    // render
    function render(list = notes){
      const grid = $('#grid');
      grid.innerHTML = '';
      if (!list.length){ $('#empty').style.display = 'block'; return; }
      $('#empty').style.display = 'none';
      list.sort((a,b) => b.updatedAt - a.updatedAt);
      for (const n of list){
        const card = document.createElement('article');
        card.className = 'card';
        const title = (n.title || '').trim() || (n.body?.split('\n')[0] || 'tanpa judul');
        const snippet = (n.body || '').length > 160 ? (n.body || '').slice(0,160) + '‚Ä¶' : (n.body || '');
        card.innerHTML = `
          <div class="menu">
            <button class="icon-btn" data-edit="${n.id}" title="edit">‚úèÔ∏è</button>
            <button class="icon-btn" data-del="${n.id}" title="hapus">üóëÔ∏è</button>
          </div>
          <h3>${escapeHtml(title)}</h3>
          <p>${escapeHtml(snippet)}</p>
          <div class="thumbs"></div>
          <div class="meta">
            <span class="pill" data-view="${n.id}">lihat</span>
            <span>${fmt(n.updatedAt)}</span>
          </div>
        `;
        const th = card.querySelector('.thumbs');
        if (Array.isArray(n.images) && n.images.length){
          n.images.slice(0,6).forEach(src => {
            const d = document.createElement('div'); d.className = 'thumb';
            d.innerHTML = `<img src="${src}" alt="gambar-catatan" />`;
            th.appendChild(d);
          });
        }

        // events
        card.querySelector('[data-edit]')?.addEventListener('click', (e) => {
          e.stopPropagation();
          openModal(n.id);
        });
        card.querySelector('[data-del]')?.addEventListener('click', (e) => {
          e.stopPropagation();
          delNote(n.id);
        });
        card.querySelector('[data-view]')?.addEventListener('click', (e) => {
          e.stopPropagation();
          viewNote(n.id);
        });

        // klik kartu juga buka view (opsional, tetap readonly)
        card.addEventListener('click', () => viewNote(n.id));

        grid.appendChild(card);
      }
    }

    function escapeHtml(str = ''){
      return String(str).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    // modal open/close
    function openModal(id = null){
      editingId = id;
      $('#overlay').style.display = 'grid';
      tempImages = [];
      $('#preview').innerHTML = '';
      $('#imgCount').textContent = '';
      if (id){
        const note = notes.find(n => n.id === id);
        $('#modalTitle').textContent = 'edit catatan';
        $('#noteTitle').value = note.title || '';
        $('#noteBody').value = note.body || '';
        tempImages = Array.isArray(note.images) ? [...note.images] : [];
        renderPreview();
      } else {
        $('#modalTitle').textContent = 'catatan baru';
        $('#noteTitle').value = '';
        $('#noteBody').value = '';
      }
      setTimeout(() => $('#noteTitle').focus(), 0);
    }
    function closeModal(){
      $('#overlay').style.display = 'none';
      editingId = null;
      tempImages = [];
      $('#preview').innerHTML = '';
      $('#imgCount').textContent = '';
      $('#noteImages').value = '';
    }

    // preview render & remove
    function renderPreview(){
      const box = $('#preview'); box.innerHTML = '';
      tempImages.forEach((src, i) => {
        const wrap = document.createElement('div'); wrap.className = 'pthumb';
        const img = document.createElement('img'); img.src = src;
        const btn = document.createElement('button'); btn.type = 'button'; btn.textContent = '√ó';
        btn.title = 'hapus gambar';
        btn.addEventListener('click', (ev) => { ev.stopPropagation(); tempImages.splice(i,1); renderPreview(); });
        wrap.appendChild(img); wrap.appendChild(btn); box.appendChild(wrap);
      });
      $('#imgCount').textContent = tempImages.length ? `${tempImages.length} gambar dipilih` : '';
    }

    // compress image helper
    async function compressImage(file, maxW = MAX_W, maxH = MAX_H, quality = JPG_QUALITY){
      const dataUrl = await new Promise((res, rej) => {
        const fr = new FileReader();
        fr.onload = () => res(fr.result);
        fr.onerror = rej;
        fr.readAsDataURL(file);
      });
      const img = await new Promise((res, rej) => {
        const i = new Image();
        i.onload = () => res(i);
        i.onerror = rej;
        i.src = dataUrl;
      });
      const { naturalWidth: w, naturalHeight: h } = img;
      const scale = Math.min(maxW / w, maxH / h, 1);
      const cw = Math.round(w * scale), ch = Math.round(h * scale);
      const canvas = document.createElement('canvas');
      canvas.width = cw; canvas.height = ch;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, cw, ch);
      return canvas.toDataURL('image/jpeg', quality);
    }

    // save note
    function saveNote(){
      const title = $('#noteTitle').value.trim();
      const body = $('#noteBody').value.trim();
      if (!body){
        alert('isi catatan tidak boleh kosong');
        return;
      }
      const now = Date.now();
      if (editingId){
        const idx = notes.findIndex(n => n.id === editingId);
        if (idx > -1){
          notes[idx] = { ...notes[idx], title, body, images: [...tempImages], updatedAt: now };
        }
      } else {
        notes.push({ id: crypto.randomUUID(), title, body, images: [...tempImages], createdAt: now, updatedAt: now });
      }
      persist();
      closeModal();
      render();
    }

    function delNote(id){
      if (!confirm('hapus catatan ini?')) return;
      notes = notes.filter(n => n.id !== id);
      persist();
      render();
    }

    // view note (readonly)
    function viewNote(id){
      const n = notes.find(x => x.id === id);
      if (!n) return;
      $('#viewTitle').textContent = n.title || 'tanpa judul';
      $('#viewBody').textContent = n.body || '';
      $('#viewDates').textContent = `dibuat: ${fmt(n.createdAt)} ‚Ä¢ diubah: ${fmt(n.updatedAt)}`;
      const box = $('#viewImages'); box.innerHTML = '';
      (n.images || []).forEach(src => {
        const img = document.createElement('img');
        img.src = src;
        img.style.width = '140px';
        img.style.height = '140px';
        img.style.objectFit = 'cover';
        img.style.borderRadius = '10px';
        img.style.border = '1px solid rgba(255,255,255,.06)';
        box.appendChild(img);
      });
      $('#viewOverlay').style.display = 'grid';
    }
    function closeView(){ $('#viewOverlay').style.display = 'none'; }

    // filter notes
    function filterNotes(q){
      q = (q || '').toLowerCase();
      const list = notes.filter(n => (n.title || '').toLowerCase().includes(q) || (n.body || '').toLowerCase().includes(q));
      render(list);
    }

    // import/export
    function exportNotes(){
      const blob = new Blob([JSON.stringify(notes, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `catatan-${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }
    function importNotes(file){
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const data = JSON.parse(reader.result);
          if (!Array.isArray(data)) throw new Error('format tidak sesuai');
          notes = data.map(n => ({
            id: n.id || crypto.randomUUID(),
            title: n.title || '',
            body: n.body || '',
            images: Array.isArray(n.images) ? n.images : [],
            createdAt: n.createdAt || Date.now(),
            updatedAt: n.updatedAt || Date.now()
          }));
          persist();
          render();
        } catch (err){
          alert('gagal impor: ' + err.message);
        }
      };
      reader.readAsText(file);
    }

    // events
    $('#addBtn').addEventListener('click', () => openModal());
    $('#cancelBtn').addEventListener('click', closeModal);
    $('#overlay').addEventListener('click', e => { if (e.target.id === 'overlay') closeModal(); });
    $('#saveBtn').addEventListener('click', saveNote);
    $('#search').addEventListener('input', e => filterNotes(e.target.value));
    $('#exportBtn').addEventListener('click', exportNotes);
    $('#importBtn').addEventListener('click', () => $('#fileInput').click());
    $('#fileInput').addEventListener('change', e => { if (e.target.files[0]) importNotes(e.target.files[0]); e.target.value = ''; });

    $('#noteImages').addEventListener('change', async (e) => {
      const files = [...e.target.files];
      if (!files.length) return;
      for (const f of files){
        try {
          const dataUrl = await compressImage(f);
          tempImages.push(dataUrl);
        } catch (err) {
          // skip failed
        }
      }
      renderPreview();
      e.target.value = '';
    });

    // view modal events
    $('#closeViewBtn').addEventListener('click', closeView);
    $('#viewOverlay').addEventListener('click', e => { if (e.target.id === 'viewOverlay') closeView(); });

    // keyboard: ctrl/cmd + enter to save
    document.addEventListener('keydown', e => {
      if ($('#overlay').style.display === 'grid' && (e.key === 'Enter') && (e.ctrlKey || e.metaKey)){
        e.preventDefault();
        saveNote();
      }
    });

    // initial render
    render();
  </script>
</body>
</html>
